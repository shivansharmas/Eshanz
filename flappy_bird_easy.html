<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flappy Bird with Background Selection</title>
<style>
body {
  margin: 0; 
  display: flex; 
  justify-content: center; 
  align-items: center; 
  height: 100vh;
  font-family: Arial, sans-serif; 
  background: #000;
}
canvas {
  border: 3px solid #000; 
  border-radius: 8px; 
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  background: transparent;
}
</style>
</head>
<body>
<canvas id="canvas" width="720" height="1000"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const pipeWidth = 52;
const pipeGap = 400;
const pipeSpeed = 2;
const maxStars = 100;
const starSize = 12;

let username = '';
do {
  username = prompt('Enter your username (max 10 characters):');
  if (username === null) { username = 'Player'; break; }
  if (username.length > 10) alert('Username too long; limit is 10 characters. Please enter a shorter name.');
} while (username.length > 10 || username.trim() === '');
username = username.trim() || 'Player';

const characters = [
  {name:'plane', x:110, y:400, width:80, height:60},
  {name:'bird', x:260, y:400, width:80, height:80},
  {name:'gorilla', x:410, y:400, width:80, height:80},
  {name:'stone', x:560, y:400, width:80, height:60},
  {name:'monkey', x:110, y:550, width:80, height:80}
];

const backgrounds = [
  {name:'Mountains', x:80, y:350, width:100, height:80},
  {name:'Beach', x:210, y:350, width:100, height:80},
  {name:'Forest', x:340, y:350, width:100, height:80},
  {name:'City', x:470, y:350, width:100, height:80},
  {name:'Regular', x:210, y:460, width:100, height:80}
];

let chosenCharacter = null;
let chosenBackground = null;
let frames = 0;
let score = 0;
let lastStarScoreThreshold = 0;
let gameState = 'selectCharacter';

const pipes = [];
const stars = [];

class Star {
  constructor(pipe) {
    this.x = pipe.x + pipe.width / 2;
    this.y = pipe.topHeight + (pipeGap / 2);
    this.size = starSize;
  }
  draw() {
    ctx.fillStyle = 'yellow';
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, 2 * Math.PI);
    ctx.fill();
  }
  checkCollision(bird) {
    const dx = this.x - (bird.x + bird.width / 2);
    const dy = this.y - (bird.y + bird.height / 2);
    const dist = Math.sqrt(dx * dx + dy * dy);
    return dist < this.size + Math.min(bird.width, bird.height) / 2;
  }
}

function drawCharacterIcon(char) {
  ctx.save();
  ctx.translate(char.x + char.width/2, char.y + char.height/2);

  ctx.strokeStyle = '#FFF';
  ctx.lineWidth = 3;
  ctx.strokeRect(-char.width/2, -char.height/2, char.width, char.height);

  ctx.fillStyle = '#000';
  ctx.font = 'bold 20px Arial';
  ctx.textAlign = 'center';
  ctx.fillText(char.name.charAt(0).toUpperCase() + char.name.slice(1), 0, char.height/2 + 25);

  if (char.name === 'plane') {
    ctx.fillStyle = '#666';
    ctx.fillRect(-30, -15, 60, 30);
    ctx.fillStyle = '#444';
    ctx.beginPath();
    ctx.moveTo(-10, 0);
    ctx.lineTo(0, -25);
    ctx.lineTo(20, 0);
    ctx.closePath();
    ctx.fill();
  } else if (char.name === 'bird') {
    ctx.fillStyle = '#FFD700';
    ctx.beginPath();
    ctx.arc(0, 0, 25, 0, Math.PI * 2);
    ctx.fill();
  } else if (char.name === 'gorilla') {
    ctx.fillStyle = '#555';
    ctx.beginPath();
    ctx.ellipse(0, 0, 30, 40, 0, 0, Math.PI * 2);
    ctx.fill();
  } else if (char.name === 'stone') {
    ctx.fillStyle = '#888';
    ctx.beginPath();
    ctx.ellipse(0, 0, 35, 20, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = '#555';
    for(let i = -15; i <= 15; i += 10){
      for(let j = -10; j <= 10; j += 10){
        ctx.beginPath();
        ctx.arc(i, j, 3, 0, Math.PI * 2);
        ctx.fill();
      }
    }
  } else if (char.name === 'monkey') {
    ctx.fillStyle = '#A0522D';
    ctx.beginPath();
    ctx.ellipse(0, 0, 30, 40, 0, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.restore();
}

function drawBackgroundIcon(bg) {
  ctx.save();
  ctx.translate(bg.x + bg.width/2, bg.y + bg.height/2);

  ctx.strokeStyle = '#FFF';
  ctx.lineWidth = 3;
  ctx.strokeRect(-bg.width/2, -bg.height/2, bg.width, bg.height);

  ctx.fillStyle = '#000';
  ctx.font = 'bold 18px Arial';
  ctx.textAlign = 'center';
  ctx.fillText(bg.name, 0, bg.height/2 + 25);

  // Draw preview of background
  if(bg.name === 'Mountains'){
    let grad = ctx.createLinearGradient(-bg.width/2, -bg.height/2, -bg.width/2, bg.height/2);
    grad.addColorStop(0, '#2E8B57');
    grad.addColorStop(1, '#90EE90');
    ctx.fillStyle = grad;
    ctx.fillRect(-bg.width/2, -bg.height/2, bg.width, bg.height);
    ctx.fillStyle = '#355E3B';
    ctx.beginPath();
    ctx.moveTo(-40, 30);
    ctx.lineTo(-10, -20);
    ctx.lineTo(20, 30);
    ctx.closePath();
    ctx.fill();
  } else if(bg.name === 'Beach'){
    let grad = ctx.createLinearGradient(-bg.width/2, -bg.height/2, -bg.width/2, bg.height/2);
    grad.addColorStop(0, '#87CEEB');
    grad.addColorStop(1, '#F0E68C');
    ctx.fillStyle = grad;
    ctx.fillRect(-bg.width/2, -bg.height/2, bg.width, bg.height);
    ctx.fillStyle = '#FFD700';
    ctx.beginPath();
    ctx.arc(-20, 10, 15, 0, Math.PI*2);
    ctx.fill();
  } else if(bg.name === 'Forest'){
    let grad = ctx.createLinearGradient(-bg.width/2, -bg.height/2, -bg.width/2, bg.height/2);
    grad.addColorStop(0, '#228B22');
    grad.addColorStop(1, '#006400');
    ctx.fillStyle = grad;
    ctx.fillRect(-bg.width/2, -bg.height/2, bg.width, bg.height);
    ctx.fillStyle = '#654321';
    ctx.fillRect(-10, -10, 8, 30);
    ctx.fillStyle = '#228B22';
    ctx.beginPath();
    ctx.arc(-6, -15, 20, 0, Math.PI*2);
    ctx.fill();
  } else if(bg.name === 'City'){
    let grad = ctx.createLinearGradient(-bg.width/2, -bg.height/2, -bg.width/2, bg.height/2);
    grad.addColorStop(0, '#4B0082');
    grad.addColorStop(1, '#FF8C00');
    ctx.fillStyle = grad;
    ctx.fillRect(-bg.width/2, -bg.height/2, bg.width, bg.height);
    ctx.fillStyle = '#333';
    ctx.fillRect(-40, 10, 15, 30);
    ctx.fillRect(-20, 0, 15, 40);
    ctx.fillRect(0, 15, 15, 25);
  } else if(bg.name === 'Regular'){
    ctx.fillStyle = '#70C5CE';
    ctx.fillRect(-bg.width/2, -bg.height/2, bg.width, bg.height);
    ctx.fillStyle = '#DED895';
    ctx.fillRect(-bg.width/2, bg.height/2 - 20, bg.width, 20);
  }

  ctx.restore();
}

const bird = {
  x: 50,
  y: 200,
  width: 40,
  height: 30,
  velocity: 0,
  gravity: 0.3,
  jump: -8,
  rotation: 0,

  draw() {
    ctx.save();
    ctx.translate(this.x + this.width / 2, this.y + this.height / 2);
    ctx.rotate((this.rotation * Math.PI)/180);

    if (!chosenCharacter) { ctx.restore(); return; }
    if (chosenCharacter === 'plane') {
      ctx.fillStyle = '#666';
      ctx.fillRect(-this.width / 2, -this.height / 6, this.width, this.height / 3);
      ctx.fillStyle = '#444';
      ctx.beginPath();
      ctx.moveTo(-this.width / 6, 0);
      ctx.lineTo(0, -this.height / 2);
      ctx.lineTo(this.width / 3, 0);
      ctx.closePath();
      ctx.fill();
      ctx.beginPath();
      ctx.moveTo(-this.width / 6, 0);
      ctx.lineTo(0, this.height / 2);
      ctx.lineTo(this.width / 3, 0);
      ctx.closePath();
      ctx.fill();
      ctx.fillRect(this.width / 3, -this.height / 8, this.width / 8, this.height / 4);
      ctx.fillStyle = '#a0d8f7';
      ctx.beginPath();
      ctx.ellipse(-this.width / 4, 0, this.width / 8, this.height / 6, 0, 0, Math.PI*2);
      ctx.fill();
    } else if (chosenCharacter === 'bird') {
      ctx.fillStyle = '#FFD700';
      ctx.beginPath();
      ctx.arc(0,0,this.height/2,0,Math.PI*2);
      ctx.fill();
      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.arc(5,-5,4,0,Math.PI*2);
      ctx.fill();
      ctx.fillStyle = '#FF6347';
      ctx.beginPath();
      ctx.moveTo(this.height/2,0);
      ctx.lineTo(this.height/2+8,-3);
      ctx.lineTo(this.height/2+8,3);
      ctx.closePath();
      ctx.fill();
    } else if (chosenCharacter === 'gorilla') {
      ctx.fillStyle = '#555';
      ctx.beginPath();
      ctx.ellipse(0,0,this.width/2,this.height/2,0,0,Math.PI*2);
      ctx.fill();
      ctx.fillStyle = '#999';
      ctx.beginPath();
      ctx.ellipse(0,0,this.width/3,this.height/3,0,0,Math.PI*2);
      ctx.fill();
      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.ellipse(-5,-5,4,5,0,0,Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(8,-5,4,5,0,0,Math.PI*2);
      ctx.fill();
      ctx.fillStyle = '#222';
      ctx.beginPath();
      ctx.ellipse(2,2,6,4,0,0,Math.PI*2);
      ctx.fill();
    } else if(chosenCharacter === 'stone') {
      ctx.fillStyle = '#888';
      ctx.beginPath();
      ctx.ellipse(0,0,this.width/2,this.height/2,0,0,Math.PI*2);
      ctx.fill();
      ctx.fillStyle = '#555';
      for(let i=-10;i<=10;i+=10){
        for(let j=-7;j<=7;j+=7){
          ctx.beginPath();
          ctx.arc(i,j,2,0,Math.PI*2);
          ctx.fill();
        }
      }
    } else if(chosenCharacter === 'monkey') {
      ctx.fillStyle = '#A0522D';
      ctx.beginPath();
      ctx.ellipse(0,0,this.width/2,this.height/2,0,0,Math.PI*2);
      ctx.fill();
    }
    ctx.restore();
  },

  update() {
    if (gameState === 'playing') {
      this.velocity += this.gravity;
      this.y += this.velocity;
      this.rotation = this.velocity < -2 ? Math.max(-25, this.velocity * 2) : Math.min(90, this.velocity * 3);
      if (this.y + this.height >= canvas.height - 50) {
        this.y = canvas.height - 50 - this.height;
        gameOver();
      }
      if (this.y <= 0) {
        this.y = 0;
        this.velocity = 0;
      }
    }
  },

  flap() {
    this.velocity = this.jump;
  },

  reset() {
    this.y = 200;
    this.velocity = 0;
    this.rotation = 0;
  },
};

function createPipe() {
  const minHeight = 50;
  const maxHeight = canvas.height - pipeGap - 100;
  const topHeight = Math.floor(Math.random() * (maxHeight - minHeight + 1)) + minHeight;
  const pipe = { x: canvas.width, topHeight: topHeight, bottomY: topHeight + pipeGap, width: pipeWidth, scored: false };
  pipes.push(pipe);

  if (stars.length < maxStars && Math.random() < 0.3) {
    stars.push(new Star(pipe));
  }
}

function drawPipes() {
  ctx.fillStyle = '#2ecc40';
  pipes.forEach(pipe => {
    ctx.fillRect(pipe.x, 0, pipe.width, pipe.topHeight);
    ctx.fillRect(pipe.x - 2, pipe.topHeight - 20, pipe.width + 4, 20);
    const bottomHeight = canvas.height - pipe.bottomY - 50;
    ctx.fillRect(pipe.x, pipe.bottomY, pipe.width, bottomHeight);
    ctx.fillRect(pipe.x - 2, pipe.bottomY, pipe.width + 4, 20);
  });
}

function updatePipes() {
  if (gameState !== 'playing') return;
  if (frames % 110 === 0) createPipe();
  for (let i = pipes.length - 1; i >= 0; i--) {
    pipes[i].x -= pipeSpeed;
    if (pipes[i].x + pipes[i].width < 0) pipes.splice(i, 1);
    else {
      if (!pipes[i].scored && bird.x > pipes[i].x + pipes[i].width) {
        pipes[i].scored = true;
        score++;
      }
      if (checkCollision(bird, pipes[i])) gameOver();
    }
  }
  updateStars();
}

function checkCollision(bird, pipe) {
  const birdLeft = bird.x;
  const birdRight = bird.x + bird.width;
  const birdTop = bird.y;
  const birdBottom = bird.y + bird.height;
  const pipeLeft = pipe.x;
  const pipeRight = pipe.x + pipe.width;
  return birdRight > pipeLeft && birdLeft < pipeRight && (birdTop < pipe.topHeight || birdBottom > pipe.bottomY);
}

function drawGround() {
  ctx.fillStyle = '#deb887';
  ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
  ctx.fillStyle = '#8b4513';
  for (let i = 0; i < canvas.width; i += 20) ctx.fillRect(i, canvas.height - 50, 10, 2);
}

function drawScore() {
  ctx.fillStyle = '#fff';
  ctx.strokeStyle = '#000';
  ctx.lineWidth = 3;
  ctx.font = 'bold 40px Arial';
  ctx.textAlign = 'center';
  if (gameState === 'playing') {
    ctx.strokeText(score, canvas.width / 2, 60);
    ctx.fillText(score, canvas.width / 2, 60);
  }
}

function drawBackground() {
  if(!chosenBackground || chosenBackground === 'Mountains') {
    let gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#2E8B57');
    gradient.addColorStop(1, '#90EE90');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    function triangle(x1, y1, x2, y2, x3, y3, color) {
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.lineTo(x3, y3);
      ctx.closePath();
      ctx.fill();
    }

    triangle(0, 600, 180, 300, 360, 600, '#355E3B');
    triangle(300, 600, 480, 350, 660, 600, '#355E3B');
    triangle(-50, 700, 120, 400, 290, 700, '#2E8B57');
    triangle(260, 700, 430, 370, 600, 700, '#2E8B57');
    triangle(-100, 800, 60, 500, 220, 800, '#238B45');
    triangle(200, 800, 380, 420, 560, 800, '#238B45');
    triangle(500, 800, 650, 550, 720, 800, '#238B45');
  } else if(chosenBackground === 'Beach') {
    let gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#87CEEB');
    gradient.addColorStop(0.6, '#F0E68C');
    gradient.addColorStop(1, '#F4A460');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#FFD700';
    ctx.beginPath();
    ctx.arc(650, 100, 60, 0, Math.PI*2);
    ctx.fill();
  } else if(chosenBackground === 'Forest') {
    let gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#228B22');
    gradient.addColorStop(1, '#006400');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    for(let i=0; i<10; i++) {
      let x = Math.random() * canvas.width;
      let y = canvas.height - 200 + Math.random() * 100;
      ctx.fillStyle = '#654321';
      ctx.fillRect(x, y, 20, 80);
      ctx.fillStyle = '#228B22';
      ctx.beginPath();
      ctx.arc(x+10, y-10, 40, 0, Math.PI*2);
      ctx.fill();
    }
  } else if(chosenBackground === 'City') {
    let gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#4B0082');
    gradient.addColorStop(0.5, '#FF8C00');
    gradient.addColorStop(1, '#FFD700');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#333';
    for(let i=0; i<8; i++) {
      let x = i * 100;
      let h = 200 + Math.random() * 300;
      ctx.fillRect(x, canvas.height - h - 50, 80, h);
    }
  } else if(chosenBackground === 'Regular') {
    ctx.fillStyle = '#70C5CE';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }
}

function updateStars() {
  for (let i = stars.length - 1; i >= 0; i--) {
    if (stars[i].checkCollision(bird)) {
      score += 5;
      stars.splice(i, 1);
    }
  }
}

function drawStars() {
  stars.forEach(star => star.draw());
}

function drawCharacterSelectScreen() {
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  characters.forEach(drawCharacterIcon);
}

function drawBackgroundSelectScreen() {
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 30px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('Choose Your Background', canvas.width/2, 280);
  backgrounds.forEach(drawBackgroundIcon);
}

function drawGameOver() {
  ctx.fillStyle = 'rgba(0,0,0,0.7)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 40px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('Game Over', canvas.width / 2, 250);
  ctx.font = '30px Arial';
  ctx.fillText(username + ' scored ' + score + ' points', canvas.width / 2, 310);
  ctx.font = '20px Arial';
  ctx.fillText('Click or Press Space to Restart', canvas.width / 2, 380);
}

function gameOver() {
  if (gameState === 'playing') gameState = 'gameover';
}

canvas.addEventListener('click', e => {
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  if (gameState === 'selectCharacter') {
    for (const char of characters) {
      if (x >= char.x && x <= char.x + char.width && y >= char.y && y <= char.y + char.height) {
        chosenCharacter = char.name;
        gameState = 'selectBackground';
        break;
      }
    }
  } else if (gameState === 'selectBackground') {
    for (const bg of backgrounds) {
      if (x >= bg.x && x <= bg.x + bg.width && y >= bg.y && y <= bg.y + bg.height) {
        chosenBackground = bg.name;
        gameState = 'playing';
        bird.reset();
        pipes.length = 0;
        score = 0;
        frames = 0;
        stars.length = 0;
        break;
      }
    }
  } else if (gameState === 'playing') {
    bird.flap();
  } else if (gameState === 'gameover') {
    gameState = 'selectCharacter';
    chosenCharacter = null;
    chosenBackground = null;
    stars.length = 0;
  }
});

document.addEventListener('keydown', e => {
  if (e.code === 'Space') {
    e.preventDefault();
    if (gameState === 'playing') bird.flap();
    else if (gameState === 'gameover') {
      gameState = 'selectCharacter';
      chosenCharacter = null;
      chosenBackground = null;
      stars.length = 0;
    }
  }
});

function gameLoop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  if(gameState === 'selectCharacter') {
    drawBackground();
    drawCharacterSelectScreen();
  } else if(gameState === 'selectBackground') {
    drawBackground();
    drawBackgroundSelectScreen();
  } else if (gameState === 'playing') {
    drawBackground();
    frames++;
    bird.update();
    updatePipes();
    updateStars();
    drawPipes();
    drawStars();
    bird.draw();
    drawGround();
    drawScore();
  } else if (gameState === 'gameover') {
    drawBackground();
    drawPipes();
    drawStars();
    bird.draw();
    drawGround();
    drawScore();
    drawGameOver();
  }

  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
